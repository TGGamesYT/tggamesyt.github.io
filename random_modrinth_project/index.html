<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Random Modrinth Project Redirect</title>
  <script>
    const projectTypes = ['mod', 'plugin', 'shader', 'resourcepack', 'modpack', 'datapack'];

    function getQueryParam(key) {
      const params = new URLSearchParams(window.location.search);
      return params.get(key);
    }

    async function fetchTotalHits(type) {
      const facets = encodeURIComponent(JSON.stringify([[`project_type:${type}`]]));
      const url = `https://api.modrinth.com/v2/search?facets=${facets}&limit=1`;
      const res = await fetch(url);
      const data = await res.json();
      return data.total_hits || 0;
    }

    async function redirectToRandomProject() {
      let type = getQueryParam("type");
      if (!projectTypes.includes(type)) {
        type = projectTypes[Math.floor(Math.random() * projectTypes.length)];
      }

      const totalHits = await fetchTotalHits(type);
      const display = document.getElementById("info");

      if (totalHits === 0) {
        display.innerText = `No projects found for type "${type}".`;
        return;
      }

      // Show total project count before redirecting
      display.innerText = `Found ${totalHits} ${type} projects. Picking a random one...`;

      const randomIndex = Math.floor(Math.random() * totalHits);
      const facets = encodeURIComponent(JSON.stringify([[`project_type:${type}`]]));
      const url = `https://api.modrinth.com/v2/search?facets=${facets}&limit=1&offset=${randomIndex}`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        const project = data.hits[0];
        if (!project) {
          display.innerText = `Could not fetch project at offset ${randomIndex}. Try again.`;
          return;
        }

        // Delay redirect by 1.5 seconds to show the message
        setTimeout(() => {
          window.location.href = `https://modrinth.com/${type}/${project.slug}`;
        }, 1500);
      } catch (err) {
        console.error(err);
        display.innerText = "Failed to load project data.";
      }
    }

    window.onload = redirectToRandomProject;
  </script>
</head>
<body>
  <p id="info">Redirecting to a random Modrinth project...</p>
</body>
</html>
