<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Final MC Panorama Fixer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; text-align: center; padding: 40px; }
        .box { border: 3px dashed #444; padding: 50px; border-radius: 15px; cursor: pointer; background: #222; transition: 0.3s; }
        .box:hover { border-color: #3c8527; background: #2a2a2a; }
        h1 { color: #3c8527; }
        button { background: #3c8527; color: white; border: none; padding: 15px 30px; border-radius: 5px; cursor: pointer; display: none; margin-top: 20px; font-weight: bold; font-size: 1.2em; }
        #status { margin-top: 20px; color: #ffcc00; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Pano2Pack Converter</h1>
    <div class="box" id="dropzone">Click or Drop Panorama (panorama.jpg)</div>
    <input type="file" id="fileInput" hidden>
    <div id="status">Waiting for image...</div>
    <button id="dlBtn">Download Resource Pack</button>

    <canvas id="outCanvas" style="display:none;"></canvas>

    <script>
        const fileInput = document.getElementById('fileInput');
        const dropzone = document.getElementById('dropzone');
        const status = document.getElementById('status');
        const dlBtn = document.getElementById('dlBtn');
        const outCanvas = document.getElementById('outCanvas');
        const ctx = outCanvas.getContext('2d');

        dropzone.onclick = () => fileInput.click();

        fileInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            status.innerText = "Processing Faces...";
            const img = new Image();
            img.src = URL.createObjectURL(file);
            
            img.onload = async () => {
                const size = 1024;
                outCanvas.width = size;
                outCanvas.height = size;
                const zip = new JSZip();
                
                // ORDER APPLIED: 
                // 2 swapped with 3 | 4 swapped with 5
                const faces = [
                    { name: "panorama_0.png", r: [0, 0] },          // Front
                    { name: "panorama_1.png", r: [Math.PI/2, 0] },  // Right
                    { name: "panorama_2.png", r: [Math.PI, 0] },    // Back (from 3)
                    { name: "panorama_3.png", r: [-Math.PI/2, 0] }, // Left (from 2)
                    { name: "panorama_4.png", r: [0, Math.PI/2] },  // Up (from 5)
                    { name: "panorama_5.png", r: [0, -Math.PI/2] }  // Down (from 4)
                ];

                const inData = await getImgData(img);

                for (let i = 0; i < faces.length; i++) {
                    const facePixels = renderFace(inData, faces[i].r, size);
                    ctx.putImageData(facePixels, 0, 0);
                    const blob = await new Promise(res => outCanvas.toBlob(res, 'image/png'));
                    zip.file(`assets/minecraft/textures/gui/title/background/${faces[i].name}`, blob);
                    
                    // Use panorama_0.png as the pack icon
                    if (faces[i].name === "panorama_0.png") zip.file("pack.png", blob);
                }

                zip.file("pack.mcmeta", JSON.stringify({
                    "pack": { 
                        "pack_format": 15, 
                        "description": "360Â° panorama pack made with tggamesyt.dev/panorama" 
                    }
                }, null, 2));

                const content = await zip.generateAsync({type:"blob"});
                dlBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(content);
                    a.download = "PanoramaPack.zip";
                    a.click();
                };
                status.innerText = "Done! Orientation and flip corrected.";
                dlBtn.style.display = "inline-block";
            };
        };

        function getImgData(img) {
            const canvas = document.createElement('canvas');
            canvas.width = img.width; canvas.height = img.height;
            const c = canvas.getContext('2d');
            c.drawImage(img, 0, 0);
            return c.getImageData(0, 0, canvas.width, canvas.height);
        }

        function renderFace(inData, rotation, size) {
            const outData = new ImageData(size, size);
            const [rotY, rotX] = rotation;

            for (let y = 0; y < size; y++) {
                for (let x = 0; x < size; x++) {
                    const xf = (2 * x / size) - 1;
                    const yf = (2 * y / size) - 1;
                    let vx, vy, vz;
                    
                    if (rotX === 0) {
                        vx = Math.cos(rotY) - xf * Math.sin(rotY);
                        vy = yf;
                        vz = Math.sin(rotY) + xf * Math.cos(rotY);
                    } else if (rotX > 0) {
                        vx = xf; vy = -1; vz = -yf;
                    } else {
                        vx = xf; vy = 1; vz = yf;
                    }

                    const mag = Math.sqrt(vx*vx + vy*vy + vz*vz);
                    const lon = Math.atan2(vz, vx);
                    const lat = Math.acos(vy / mag);

                    const px = (lon + Math.PI) / (2 * Math.PI) * inData.width;
                    const py = (1 - (lat / Math.PI)) * inData.height; // Vertical Flip

                    const outIdx = (y * size + x) * 4;
                    const inIdx = (Math.floor(py) * inData.width + Math.floor(px)) * 4;

                    outData.data[outIdx] = inData.data[inIdx];
                    outData.data[outIdx+1] = inData.data[inIdx+1];
                    outData.data[outIdx+2] = inData.data[inIdx+2];
                    outData.data[outIdx+3] = 255;
                }
            }
            return outData;
        }
    </script>
</body>
</html>
