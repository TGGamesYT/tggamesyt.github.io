<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>360° Panorama Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --primary: #3c8527; --primary-hover: #4ca632; --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; align-items: center; padding: 40px 20px; }
        .container { width: 100%; max-width: 850px; }
        
        /* THE BIG PANORAMA PREVIEW */
        .pano-display { 
            width: 100%;
            height: 350px; 
            border-radius: 12px; 
            overflow: hidden; 
            position: relative; 
            background: #000; 
            border: 1px solid #333;
            margin-bottom: 30px;
            display: none; /* Hidden until image is processed */
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        /* The strip containing Front, Right, Back, Left, and Front again for seamless loop */
        .pano-mover { 
            height: 100%; 
            width: 500%; /* 5 panels (F, R, B, L, F) */
            display: flex;
            animation: rotateCinema 30s linear infinite;
        }
        
        .pano-panel {
            height: 100%;
            flex: 1;
            background-size: cover;
            background-position: center;
        }

        @keyframes rotateCinema {
            from { transform: translateX(0); }
            to { transform: translateX(-80%); } /* Moves through first 4 panels */
        }

        .upload-section { background: var(--card); border: 2px dashed #444; border-radius: 12px; padding: 60px; text-align: center; cursor: pointer; transition: 0.3s; }
        .upload-section:hover { border-color: var(--primary); background: #252525; }
        
        .pack-card { background: #252525; padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 15px; border: 1px solid #333; margin: 20px 0; display: none; }
        .pack-icon { width: 64px; height: 64px; background: #000; border: 1px solid #555; image-rendering: pixelated; }
        .pack-info { text-align: left; }
        .pack-title { color: #fff; font-weight: bold; font-size: 14px; }
        .pack-desc { color: #888; font-size: 12px; margin-top: 4px; }

        button { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; display: none; font-size: 16px; }
        button:hover { background: var(--primary-hover); }
        #status { margin: 15px 0; color: var(--primary); font-weight: bold; font-family: monospace; }
        canvas { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center; font-weight: 300;">Panorama to Resource Pack</h1>

    <div class="pano-display" id="panoDisplay">
        <div class="pano-mover" id="panoMover">
            <div class="pano-panel" id="panel0"></div>
            <div class="pano-panel" id="panel1"></div>
            <div class="pano-panel" id="panel2"></div>
            <div class="pano-panel" id="panel3"></div>
            <div class="pano-panel" id="panel4"></div> </div>
    </div>
    
    <div class="upload-section" id="dropzone">
        <strong>Drop your 360° panorama.jpg here</strong>
        <p style="font-size: 0.8em; color: #777;">Equirectangular photo sphere</p>
    </div>
    
    <input type="file" id="fileInput" accept="image/*" hidden>
    <div id="status"></div>

    <div class="pack-card" id="packCard">
        <img id="iconPreview" class="pack-icon">
        <div class="pack-info">
            <div class="pack-title">PanoramaPack.zip</div>
            <div class="pack-desc">360° panorama pack made with tggamesyt.dev/panorama</div>
        </div>
    </div>

    <button id="dlBtn">DOWNLOAD RESOURCE PACK</button>
</div>

<canvas id="outCanvas"></canvas>
<canvas id="rotateCanvas"></canvas>

<script>
    const fileInput = document.getElementById('fileInput');
    const dropzone = document.getElementById('dropzone');
    const status = document.getElementById('status');
    const dlBtn = document.getElementById('dlBtn');
    const panoDisplay = document.getElementById('panoDisplay');
    const packCard = document.getElementById('packCard');
    const panoMover = document.getElementById('panoMover');
    
    const outCanvas = document.getElementById('outCanvas');
    const rotCanvas = document.getElementById('rotateCanvas');
    const ctx = outCanvas.getContext('2d');
    const rotCtx = rotCanvas.getContext('2d');

    dropzone.onclick = () => fileInput.click();

    fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        status.innerText = "Slicing 360° Sphere...";
        const img = new Image();
        img.src = URL.createObjectURL(file);
        
        img.onload = async () => {
            const size = 1024;
            outCanvas.width = size;
            outCanvas.height = size;
            rotCanvas.width = size;
            rotCanvas.height = size;
            const zip = new JSZip();
            
            const faces = [
                { name: "panorama_0.png", r: [0, 0] },          // Front
                { name: "panorama_1.png", r: [Math.PI/2, 0] },  // Right
                { name: "panorama_2.png", r: [Math.PI, 0] },    // Back
                { name: "panorama_3.png", r: [-Math.PI/2, 0] }, // Left
                { name: "panorama_4.png", r: [0, Math.PI/2] },  // Up
                { name: "panorama_5.png", r: [0, -Math.PI/2] }  // Down
            ];

            const inData = await getImgData(img);
            const urls = [];

            for (let i = 0; i < faces.length; i++) {
                const facePixels = renderFace(inData, faces[i].r, size);
                ctx.putImageData(facePixels, 0, 0);

                if (faces[i].name === "panorama_5.png") {
                    rotCtx.clearRect(0,0,size,size);
                    rotCtx.save();
                    rotCtx.translate(size/2, size/2);
                    rotCtx.rotate(-Math.PI / 2);
                    rotCtx.drawImage(outCanvas, -size/2, -size/2);
                    rotCtx.restore();
                    var finalBlob = await new Promise(res => rotCanvas.toBlob(res, 'image/png'));
                } else {
                    var finalBlob = await new Promise(res => outCanvas.toBlob(res, 'image/png'));
                }
                
                const url = URL.createObjectURL(finalBlob);
                urls.push(url);

                zip.file(`assets/minecraft/textures/gui/title/background/${faces[i].name}`, finalBlob);
                if (i === 0) {
                    document.getElementById('iconPreview').src = url;
                    zip.file("pack.png", finalBlob);
                }
            }

            // Setup the cinematic rotation preview
            document.getElementById('panel0').style.backgroundImage = `url(${urls[0]})`;
            document.getElementById('panel1').style.backgroundImage = `url(${urls[1]})`;
            document.getElementById('panel2').style.backgroundImage = `url(${urls[2]})`;
            document.getElementById('panel3').style.backgroundImage = `url(${urls[3]})`;
            document.getElementById('panel4').style.backgroundImage = `url(${urls[0]})`; // Loop back to Front

            zip.file("pack.mcmeta", JSON.stringify({
                "pack": { "pack_format": 15, "description": "360° panorama pack made with tggamesyt.dev/panorama" }
            }, null, 2));

            const content = await zip.generateAsync({type:"blob"});
            
            status.innerText = "";
            panoDisplay.style.display = "block";
            packCard.style.display = "flex";
            dlBtn.style.display = "block";

            dlBtn.onclick = () => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(content);
                a.download = "PanoramaPack.zip";
                a.click();
            };
        };
    };

    function getImgData(img) {
        const canvas = document.createElement('canvas');
        canvas.width = img.width; canvas.height = img.height;
        const c = canvas.getContext('2d');
        c.drawImage(img, 0, 0);
        return c.getImageData(0, 0, canvas.width, canvas.height);
    }

    function renderFace(inData, rotation, size) {
        const outData = new ImageData(size, size);
        const [rotY, rotX] = rotation;
        for (let y = 0; y < size; y++) {
            for (let x = 0; x < size; x++) {
                const xf = (2 * x / size) - 1;
                const yf = (2 * y / size) - 1;
                let vx, vy, vz;
                if (rotX === 0) {
                    vx = Math.cos(rotY) - xf * Math.sin(rotY);
                    vy = yf;
                    vz = Math.sin(rotY) + xf * Math.cos(rotY);
                } else if (rotX > 0) {
                    vx = xf; vy = -1; vz = -yf;
                } else {
                    vx = xf; vy = 1; vz = yf;
                }
                const mag = Math.sqrt(vx*vx + vy*vy + vz*vz);
                const lon = Math.atan2(vz, vx);
                const lat = Math.acos(vy / mag);
                const px = (lon + Math.PI) / (2 * Math.PI) * inData.width;
                const py = (1 - (lat / Math.PI)) * inData.height;
                const outIdx = (y * size + x) * 4;
                const inIdx = (Math.floor(py) * inData.width + Math.floor(px)) * 4;
                outData.data[outIdx] = inData.data[inIdx];
                outData.data[outIdx+1] = inData.data[inIdx+1];
                outData.data[outIdx+2] = inData.data[inIdx+2];
                outData.data[outIdx+3] = 255;
            }
        }
        return outData;
    }
</script>
</body>
</html>
