<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Shared Docs</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:system-ui,Arial;max-width:900px;margin:28px auto;padding:0 12px}
textarea{width:100%;height:300px;font-family:monospace;font-size:13px}
button{padding:8px 12px;border-radius:6px;border:1px solid #888;background:#f3f3f3;cursor:pointer}
.doc-title{font-weight:bold;margin-top:12px; cursor:pointer;}
.doc-content{border:1px solid #ccc;padding:8px;margin-bottom:12px}
h1,h2,h3,h4,h5,h6{margin-top:1em;margin-bottom:.5em}
strong,b{font-weight:bold}
em,i{font-style:italic}
</style>
</head>
<body>
<h1>Shared Documents</h1>

<div id="loginDiv">
  <input type="text" id="username" placeholder="Username">
  <input type="password" id="password" placeholder="Password">
  <button id="loginBtn">Login</button>
  <div id="loginStatus"></div>
</div>

<div id="mainDiv" style="display:none">
  <div id="docsList"></div>
  <div id="editorDiv" style="display:none">
    <div class="doc-title" id="docTitle"></div>
    <textarea id="docContent"></textarea><br>
    <button id="saveBtn">Save</button>
    <div id="saveStatus"></div>
  </div>
</div>

<script>
const WORKER_BASE = "https://docs.tgdoescode.workers.dev";
let token = localStorage.getItem("sessionId") || "";

// Try auto-login if session exists
async function tryAutoLogin() {
  if(!token) return;
  const res = await fetch(WORKER_BASE+"/docs", {
    headers: {"Authorization": "Bearer "+token}
  });
  const data = await res.json();
  if(data.ok){
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("mainDiv").style.display="block";
    loadDocs();
  } else {
    localStorage.removeItem("sessionId");
    token = "";
  }
}
tryAutoLogin();

document.getElementById("loginBtn").onclick = async ()=> {
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;
  document.getElementById("loginStatus").textContent = "Logging in...";
  try {
    const res = await fetch(WORKER_BASE+"/login", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({username,password})
    });
    const data = await res.json();
    if(data.ok){
      token = data.sessionId;
      localStorage.setItem("sessionId", token);
      document.getElementById("loginDiv").style.display="none";
      document.getElementById("mainDiv").style.display="block";
      loadDocs();
    } else {
      document.getElementById("loginStatus").textContent = data.error;
    }
  } catch(e) {
    document.getElementById("loginStatus").textContent = "Error connecting to server";
  }
};

async function loadDocs(){
  const res = await fetch(WORKER_BASE+"/docs", {headers:{"Authorization":"Bearer "+token}});
  const data = await res.json();
  const listDiv = document.getElementById("docsList");
  listDiv.innerHTML = "";
  if(!data.ok){
    listDiv.textContent = data.error;
    if(data.error === "Unauthorized") {
      localStorage.removeItem("sessionId");
      token = "";
      document.getElementById("loginDiv").style.display="block";
      document.getElementById("mainDiv").style.display="none";
    }
    return;
  }
  data.docs.forEach(doc => {
    const d = document.createElement("div");
    d.textContent = doc.title;
    d.className = "doc-title";
    d.onclick = () => editDoc(doc.id, doc.title);
    listDiv.appendChild(d);
  });
}

async function editDoc(id,title){
  const res = await fetch(WORKER_BASE+"/docs/"+id,{headers:{"Authorization":"Bearer "+token}});
  const data = await res.json();
  if(!data.ok){ alert(data.error); return; }
  document.getElementById("editorDiv").style.display="block";
  document.getElementById("docTitle").textContent = title;
  document.getElementById("docContent").value = data.doc.content;
  document.getElementById("saveBtn").onclick = async ()=>{
    const content = document.getElementById("docContent").value;
    const res2 = await fetch(WORKER_BASE+"/docs/"+id,{
      method:"POST",
      headers:{"Content-Type":"application/json","Authorization":"Bearer "+token},
      body:JSON.stringify({content})
    });
    const d2 = await res2.json();
    document.getElementById("saveStatus").textContent = d2.ok?"Saved":"Error: "+(d2.error||"unknown");
  }
}
</script>
</body>
</html>
