<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Street View → Equirectangular (Safe Canvas)</title>
<style>
  body { background:#0f0f0f; color:#eee; font-family:system-ui, sans-serif; max-width:720px; margin:30px auto; }
  input, button { width:100%; padding:10px; margin-top:8px; background:#1e1e1e; color:white; border:1px solid #333; border-radius:6px; }
  button { cursor:pointer; }
  progress { width:100%; height:18px; margin-top:12px; }
  canvas { display:none; }
  .modal { position:fixed; inset:0; background:rgba(0,0,0,0.7); display:none; align-items:center; justify-content:center; z-index:999; }
  .modal-box { background:#1b1b1b; border:1px solid #333; border-radius:10px; padding:20px; max-width:520px; width:90%; }
  .modal-box h3 { margin-top:0; }
  .modal-box pre { background:#111; padding:10px; border-radius:6px; overflow:auto; max-height:200px; font-size:12px; }
  .error h3 { color:#ff6b6b; }
  .modal-box img { width:100%; border-radius:6px; }
</style>
</head>
<body>

<h2>Street View → Equirectangular (Safe Canvas)</h2>

<input id="input" placeholder="Panorama ID or Google Maps Street View URL">
<button id="start">Convert</button>

<progress id="progress" value="0" max="1" hidden></progress>

<button id="preview" hidden>Preview Image</button>
<button id="download" hidden>Download Image</button>

<canvas id="canvas"></canvas>

<!-- Error modal -->
<div id="errorModal" class="modal">
  <div class="modal-box error">
    <h3>Conversion Error</h3>
    <p id="errorMessage"></p>
    <pre id="errorDetails"></pre>
    <button onclick="closeError()">Close</button>
  </div>
</div>

<!-- Preview modal -->
<div id="previewModal" class="modal">
  <div class="modal-box">
    <h3>Panorama Preview</h3>
    <img id="previewImg">
    <button onclick="closePreview()">Close</button>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const TILE_SIZE = 512;
const ZOOM = 3;          // 8x4 tiles = 4096x2048
const TILES_X = 8;
const TILES_Y = 4;
const CONCURRENCY = 6;

/* ---------- ELEMENTS ---------- */
const input = document.getElementById("input");
const startBtn = document.getElementById("start");
const progress = document.getElementById("progress");
const previewBtn = document.getElementById("preview");
const downloadBtn = document.getElementById("download");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const errorModal = document.getElementById("errorModal");
const errorMessage = document.getElementById("errorMessage");
const errorDetails = document.getElementById("errorDetails");

const previewModal = document.getElementById("previewModal");
const previewImg = document.getElementById("previewImg");

/* ---------- HELPERS ---------- */
function showError(message, details = "") {
  errorMessage.textContent = message;
  errorDetails.textContent = details;
  errorModal.style.display = "flex";
}

function closeError() { errorModal.style.display = "none"; }
function closePreview() { previewModal.style.display = "none"; }

function extractPanoid(text) {
  if (!text) return null;
  if (!text.includes("google.com")) return text.trim();
  const match = text.match(/!1s([^!]+)/);
  return match ? match[1] : null;
}

// Use proxy URL for safe CORS
function tileUrl(panoid, x, y) {
    return `https://cbk0.google.com/cbk?output=tile&panoid=${panoid}&zoom=${ZOOM}&x=${x}&y=${y}`;
}

// Load image with crossOrigin before src
function loadImage(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => resolve(img);
    img.onerror = () => reject(new Error("Tile failed to load: " + url));
    img.src = url;
  });
}

/* ---------- MAIN ---------- */
startBtn.onclick = async () => {
  try {
    const panoid = extractPanoid(input.value);
    if (!panoid) throw new Error("Invalid panorama ID or URL");

    canvas.width = TILES_X * TILE_SIZE;
    canvas.height = TILES_Y * TILE_SIZE;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    progress.hidden = false;
    progress.value = 0;
    previewBtn.hidden = true;
    downloadBtn.hidden = true;

    const tasks = [];
    for (let y = 0; y < TILES_Y; y++) {
      for (let x = 0; x < TILES_X; x++) {
        tasks.push({ x, y });
      }
    }

    let completed = 0;

    async function worker() {
      while (tasks.length) {
        const task = tasks.shift();
        if (!task) return;
        try {
          const img = await loadImage(tileUrl(panoid, task.x, task.y));
          ctx.drawImage(img, task.x * TILE_SIZE, task.y * TILE_SIZE);
        } catch (err) {
          throw new Error(`Tile failed: x=${task.x}, y=${task.y}`);
        }
        completed++;
        progress.value = completed / (TILES_X * TILES_Y);
        await new Promise(r => setTimeout(r, 0)); // yield
      }
    }

    await Promise.all(Array(CONCURRENCY).fill(0).map(worker));

    progress.hidden = true;
    previewBtn.hidden = false;
    downloadBtn.hidden = false;

  } catch (err) {
    progress.hidden = true;
    showError("The panorama could not be converted.", err.stack || err.message);
  }
};

/* ---------- PREVIEW ---------- */
previewBtn.onclick = () => {
  previewImg.src = canvas.toDataURL("image/png");
  previewModal.style.display = "flex";
};

/* ---------- DOWNLOAD ---------- */
downloadBtn.onclick = () => {
  const a = document.createElement("a");
  a.download = "panorama.png";
  a.href = canvas.toDataURL("image/png");
  a.click();
};
</script>

</body>
</html>
