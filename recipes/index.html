<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Minecraft Recipe Browser (offline JEI)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous"></script>
  <style>
    :root{--bg:#0b0f14;--card:#0f1720;--muted:#9aa6b2;--accent:#6ee7b7}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{background:linear-gradient(180deg,#071021 0%, #0b1622 100%);color:#e6eef6;padding:18px}
    .app{max-width:1140px;margin:0 auto}
    header{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    h1{margin:0;font-size:20px}
    .uploader{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
    .drop{flex:1;min-width:280px;border:2px dashed rgba(255,255,255,0.06);padding:16px;border-radius:8px;background:rgba(255,255,255,0.01)}
    .btn{background:var(--accent);color:#042018;padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .two{display:grid;grid-template-columns:320px 1fr;gap:12px;margin-top:12px}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px}
    .list{max-height:64vh;overflow:auto}
    .recipe-item{padding:8px;border-radius:6px;margin-bottom:6px;cursor:pointer}
    .recipe-item:hover{background:rgba(255,255,255,0.02)}
    .grid{display:grid;grid-template-columns:repeat(3,64px);gap:6px}
    .slot{width:64px;height:64px;border-radius:6px;background:#071021;display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.03);position:relative}
    .slot img{max-width:54px;max-height:54px}
    .title{font-weight:600}
    input[type=search], select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    .meta{color:var(--muted);font-size:13px}
    .note{color:var(--muted);font-size:13px;margin-top:8px}
    .small{font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Minecraft Recipe Browser</h1>
      <div class="small">Upload jars manually or fetch vanilla client via Mojang Piston meta</div>
    </header><div class="uploader">
  <div class="drop panel" id="drop">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <strong>Drop one or more .jar/.zip files</strong>
        <div class="meta">vanilla jars, mod jars (Forge/Fabric), resourcepacks</div>
      </div>
      <div>
        <label class="btn">Choose files<input id="fileInput" type="file" accept=".jar,.zip" multiple style="display:none"></label>
      </div>
    </div>
    <div class="note">Scans <code>data/*/recipes/</code> and <code>data/*/recipe/</code>, loads textures/lang when found.</div>
  </div>

  <div style="width:280px;display:flex;flex-direction:column;gap:8px">
    <button class="btn" id="exportBtn">Export recipes JSON</button>
    <div class="panel small" id="stats">No files loaded</div>
    <div class="panel small">
      <div><strong>Fetch vanilla client jar</strong></div>
      <select id="versionSelect"></select>
      <button class="btn" id="downloadBtn">Download & Load</button>
      <div class="note">Uses Mojang's official Piston meta + client jar</div>
    </div>
  </div>
</div>

<div class="two">
  <div class="panel">
    <input id="search" type="search" placeholder="Search recipes or items..." />
    <div class="list" id="recipeList"></div>
  </div>

  <div class="panel" id="viewer">
    <div id="viewerInner"><div class="meta">Select a recipe to view details</div></div>
  </div>
</div>

  </div><script>
(async function(){
  const drop = document.getElementById('drop');
  const fileInput = document.getElementById('fileInput');
  const recipeList = document.getElementById('recipeList');
  const viewer = document.getElementById('viewerInner');
  const stats = document.getElementById('stats');
  const exportBtn = document.getElementById('exportBtn');
  const search = document.getElementById('search');
  const versionSelect = document.getElementById('versionSelect');
  const downloadBtn = document.getElementById('downloadBtn');

  let state = {
    files: [],
    recipes: [],
    assets: {},
    langs: {},
    models: {},
    versionMeta: null,
  };

  function setStats(){
    stats.innerHTML = `${state.files.length} files • ${state.recipes.length} recipes • ${Object.keys(state.assets).length} assets`;
  }

  async function handleFiles(fileList){
    recipeList.innerHTML = '<div class="meta">Scanning...</div>';
    for(const f of fileList){
      const buff = await f.arrayBuffer();
      const zip = await JSZip.loadAsync(buff);
      state.files.push({name:f.name,zip,raw:f});

      for(const path in zip.files){
        const entry = zip.files[path];
        if(entry.dir) continue;
        // recipes or recipe (support both)
        if(/^data\/[^\/]+\/(recipes|recipe)\/.*\.json$/.test(path)){
          try{
            const jsonText = await entry.async('string');
            const json = JSON.parse(jsonText);
            const match = path.match(/^data\/([^\/]+)\/(recipes|recipe)\/(.+)\.json$/);
            const namespace = match[1];
            const recipePath = match[3];
            const id = namespace+':'+recipePath;
            state.recipes.push({id,namespace,path:recipePath,json,source:f.name});
          }catch(e){console.warn('bad recipe',path,e)}
        }
        // assets: textures
        if(/^assets\/[^\/]+\/textures\/.*\.(png|jpg)$/.test(path)){
          const key = path.replace(/^assets\//,'');
          state.assets[key] = state.assets[key] || [];
          state.assets[key].push({file:f.name,entry});
        }
        // models
        if(/^assets\/[^\/]+\/models\/.*\.json$/.test(path)){
          try{
            const txt = await entry.async('string');
            const j = JSON.parse(txt);
            state.models[path.replace(/^assets\//,'')] = j;
          }catch(e){console.warn('model parse',path,e)}
        }
        // langs
        if(/^assets\/[^\/]+\/lang\/.*\.(json|lang)$/.test(path)){
          const match = path.match(/^assets\/([^\/]+)\/lang\/([^\/]+)\.(json|lang)$/);
          if(match){
            const locale = match[2];
            const ext = match[3];
            try{
              const txt = await entry.async('string');
              state.langs[locale] = state.langs[locale] || {};
              if(ext==='json'){
                Object.assign(state.langs[locale], JSON.parse(txt));
              }else{
                txt.split(/\r?\n/).forEach(line=>{
                  if(!line || line.startsWith('#')) return;
                  const idx=line.indexOf('=');
                  if(idx>0){
                    const k=line.slice(0,idx).trim();
                    const v=line.slice(idx+1).trim();
                    state.langs[locale][k]=v;
                  }
                });
              }
            }catch(e){console.warn('lang parse',path,e)}
          }
        }
      }
    }
    setStats();
    renderRecipeList();
  }

  function matchesSearch(r,q){
    q=q.trim().toLowerCase();
    if(!q) return true;
    if(r.id.toLowerCase().includes(q)) return true;
    try{ if(JSON.stringify(r.json).toLowerCase().includes(q)) return true;}catch(e){}
    return false;
  }

  function renderRecipeList(){
    recipeList.innerHTML = '';
    const q = search.value || '';
    const sorted = state.recipes.slice().sort((a,b)=>a.id.localeCompare(b.id));
    for(const r of sorted){
      if(!matchesSearch(r,q)) continue;
      const div = document.createElement('div');
      div.className='recipe-item';
      div.innerHTML = `<div class="title">${escapeHtml(r.id)}</div><div class="meta">source: ${escapeHtml(r.source)}</div>`;
      div.onclick = ()=>showRecipe(r);
      recipeList.appendChild(div);
    }
    if(recipeList.children.length===0) recipeList.innerHTML='<div class="meta">No recipes matched.</div>';
  }

  function escapeHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

  async function entryBlobURL(entry){
    const arr = await entry.async('arraybuffer');
    return URL.createObjectURL(new Blob([arr]));
  }

  async function findTextureForItem(itemId){
    const [mod,id] = (itemId||'').split(':');
    if(!id) return null;
    const candidates = [
      `minecraft/textures/item/${id}.png`,
      `${mod}/textures/item/${id}.png`,
      `${mod}/textures/block/${id}.png`
    ];
    for(const cand of candidates){
      if(state.assets[cand]){
        try{ return await entryBlobURL(state.assets[cand][0].entry); }catch(e){}
      }
    }
    for(const k in state.assets){
      if(k.endsWith('/'+id+'.png')){
        try{ return await entryBlobURL(state.assets[k][0].entry); }catch(e){}
      }
    }
    return null;
  }

  async function showRecipe(r){
    viewer.innerHTML = '<div class="meta">Loading recipe preview...</div>';
    const json = r.json;
    const type = json.type || 'crafting_shaped';
    let ingredients = [];
    let result = null;

    if(type.includes('shaped')){
      const pattern = json.pattern || [];
      const key = json.key || {};
      let displayGrid = Array(9).fill(null);
      const width = pattern.reduce((m,row)=>Math.max(m,row.length),0);
      const height = pattern.length||0;
      const padLeft = Math.floor((3-width)/2);
      const padTop = Math.floor((3-height)/2);
      for(let y=0;y<height;y++){
        for(let x=0;x<pattern[y].length;x++){
          const ch = pattern[y][x];
          const ent = key[ch];
          if(ent){ displayGrid[(y+padTop)*3+(x+padLeft)] = ent.item||null; }
        }
      }
      ingredients = displayGrid;
      result = json.result?.item || json.result;
    }else if(type.includes('shapeless')){
      const list = json.ingredients||[];
      ingredients = Array(9).fill(null);
      for(let i=0;i<Math.min(9,list.length);i++) ingredients[i] = list[i].item||null;
      result = json.result?.item || json.result;
    }else if(type.includes('smelt')){
      const ing = json.ingredient || json.ingredients?.[0];
      ingredients = [ing?.item||null];
      result = json.result?.item || json.result;
    }

    viewer.innerHTML = `<div class="title">${escapeHtml(r.id)}</div><div class="meta">type: ${escapeHtml(type)} • source: ${escapeHtml(r.source)}</div>`;
    const grid = document.createElement('div'); grid.className='grid';
    for(let i=0;i<9;i++){
      const slot=document.createElement('div');slot.className='slot';
      const id=ingredients[i];
      if(id){ const img=document.createElement('img'); img.alt=id; findTextureForItem(id).then(u=>img.src=u||''); slot.appendChild(img);} 
      grid.appendChild(slot);
    }
    viewer.appendChild(grid);
    const resSlot=document.createElement('div');resSlot.className='slot';
    if(result){const img=document.createElement('img'); img.alt=result; findTextureForItem(result).then(u=>img.src=u||''); resSlot.appendChild(img);} else resSlot.textContent='-';
    viewer.appendChild(resSlot);
  }

  // piston meta support
  async function loadVersionManifest(){
    try{
      const res = await fetch('https://piston-meta.mojang.com/mc/game/version_manifest_v2.json');
      const j = await res.json();
      state.versionMeta = j;
      versionSelect.innerHTML = '';
      j.versions.slice(0,50).forEach(v=>{
        const opt=document.createElement('option'); opt.value=v.url; opt.textContent=v.id; versionSelect.appendChild(opt);
      });
    }catch(e){versionSelect.innerHTML='<option>Error fetching manifest</option>'}
  }

  async function downloadAndLoad(){
    const url = versionSelect.value; if(!url) return;
    const res = await fetch(url); const j = await res.json();
    const clientUrl = j.downloads.client.url;
    const fileRes = await fetch(clientUrl);
    const blob = await fileRes.blob();
    const file = new File([blob], j.id+".jar");
    handleFiles([file]);
  }

  // init
  drop.addEventListener('dragover',e=>{e.preventDefault();});
  drop.addEventListener('drop',e=>{e.preventDefault(); const files=[...e.dataTransfer.files].filter(f=>f.name.endsWith('.jar')||f.name.endsWith('.zip')); if(files.length) handleFiles(files);});
  fileInput.addEventListener('change',e=>{const files=[...e.target.files].filter(f=>f.name.endsWith('.jar')||f.name.endsWith('.zip')); if(files.length) handleFiles(files)});
  search.addEventListener('input',renderRecipeList);
  exportBtn.addEventListener('click',()=>{const out=state.recipes.map(r=>({id:r.id,json:r.json,source:r.source})); const blob=new Blob([JSON.stringify(out,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='recipes-export.json'; a.click();});
  downloadBtn.addEventListener('click',downloadAndLoad);

  loadVersionManifest();
})();
</script></body>
</html>
