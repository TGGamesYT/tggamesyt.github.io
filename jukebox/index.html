<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Minecraft Music Disc Player</title>
  <style>
    body {
      background: #111;
      color: white;
      font-family: sans-serif;
      text-align: center;
      padding: 40px;
    }
    .jukebox {
      width: 160px;
      height: 160px;
      margin: auto;
      position: relative;
      background: url("https://minecraft.wiki/images/Jukebox_JE2_BE2.png") center/cover no-repeat;
      /*border-radius: 8px;
      border: 4px solid #333;
      overflow: hidden;*/
    }
    .jukebox img {
      width: 100px;
      height: 100px;
      position: absolute;
      top: 30px;
      left: 30px;
      image-rendering: pixelated;
    }
    #drag-area {
      border: 3px dashed #555;
      padding: 30px;
      margin-top: 30px;
      width: 320px;
      background: #222;
      border-radius: 10px;
      margin-left: auto;
      margin-right: auto;
      position: relative;
    }
    #inventory {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      padding: 10px;
      background: #333;
      margin-top: 20px;
      border-radius: 10px;
      border: 2px solid #444;
    }
    .inventory-slot {
      width: 60px;
      height: 60px;
      background-color: #555;
      border-radius: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      border: 2px dashed #888;
      cursor: pointer;
    }
    .inventory-slot img {
      max-width: 100%;
      max-height: 100%;
    }
    #audio-player {
      margin-top: 30px;
      width: 300px;
    }
    a { color: #7cf; }

    /* Notes styling */
    .note {
      position: absolute;
      /*top: -10px;
      left: 70%;*/
      transform: translateX(-50%);
      opacity: 0;
      z-index: 10; /* Ensure notes appear above everything else */
      animation: floatUp 1s ease-out forwards, fadeIn 0.5s ease-out forwards;
    }

    @keyframes floatUp {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(-100px); opacity: 0; }
    }

    @keyframes fadeIn {
      0% { opacity: 0; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <h1>Minecraft Music Disc Player</h1>
  <div id="drag-area">
  <div class="jukebox" id="jukebox">
    <img id="disc-image" src="https://tggamesyt.github.io/jukebox/empty.png" alt="Music Disc" title="Playing Music Disc">
  </div>
  </div>
    <p>ðŸŽµ Drag & drop a music disc image</p>
    <p><small>From <a href="https://minecraft.wiki/w/Music_Disc" target="_blank">Minecraft Wiki</a></small></p>
    <p>if you are using a browser that doesnt support image dragging, add ?disc=whateverdiscyouwant to play that disc.</p>
    <p>example: <a href="https://tggamesyt.github.io/jukebox?disc=pigstep">https://tggamesyt.github.io/jukebox?disc=pigstep</a></p>
  <div id="inventory">
    <!-- Inventory slots for storing discs -->
    <div class="inventory-slot"><img id="slot-1" src="https://minecraft.wiki/images/Invicon_Music_Disc_Pigstep.png" alt="Music Disc" title="Inventory Music Disc"></div>
    <div class="inventory-slot"><img id="slot-2" src="https://minecraft.wiki/images/Invicon_Music_Disc_Otherside.png" alt="Music Disc" title="Inventory Music Disc"></div>
    <div class="inventory-slot"><img id="slot-3" src="https://minecraft.wiki/images/Invicon_Music_Disc_Creator.png" alt="Music Disc" title="Inventory Music Disc"></div>
    <div class="inventory-slot"><img id="slot-4" src="https://minecraft.wiki/images/Invicon_Music_Disc_Relic.png" alt="Music Disc" title="Inventory Music Disc"></div>
  </div>

  <audio id="audio-player" controls></audio>

  <script>
    const discImage = document.getElementById('disc-image');
    const audioPlayer = document.getElementById('audio-player');
    const dragArea = document.getElementById('drag-area');
    const jukebox = document.getElementById('jukebox');
    const inventorySlots = document.querySelectorAll('.inventory-slot');
    const allowedNumbers = ["11", "13", "5"];
    let noteInterval = null; // Used to manage note spawning intervals
    let isPlaying = false; // Flag to track whether music is playing

    function normalizeDiscName(filename) {
      const match = filename.match(/Music_Disc_(.+?)\.png/i);
      if (!match) return null;
      let raw = decodeURIComponent(match[1]).toLowerCase();
      raw = raw.replace(/[^a-z0-9_]/g, "_").replace(/\b(\d+)\b/g, m => allowedNumbers.includes(m) ? m : "");
      return raw.replace(/_+/g, "_").replace(/^_|_$/g, "");
    }

    function buildOggUrl(discName) {
      return `https://tggamesyt.github.io/jukebox/${discName}.ogg`;
    }

    function spawnNote() {
      if (!isPlaying) return; // Don't spawn notes if music is paused or stopped

      const note = document.createElement("img");
      note.className = "note";
      note.title = "Note"

      // Randomize the note number (1-24)
      const noteNumber = Math.floor(Math.random() * 24) + 1;
      note.src = `https://tggamesyt.github.io/jukebox/note_${noteNumber}.png`;

      // Resize the note to half the size of the jukebox while maintaining its aspect ratio
      note.style.width = "80px";  // Half the size of the jukebox (160px) while maintaining the aspect ratio

      jukebox.appendChild(note);

      // Remove the note after its animation (1.5s total)
      setTimeout(() => note.remove(), 1500);

      // Spawn the next note after 2 seconds (500ms after the previous note fades out)
      setTimeout(spawnNote, 2000); // Adjusted to spawn every 2 seconds
    }

    function startNotes() {
      if (isPlaying) return; // Prevent starting multiple intervals while already playing

      isPlaying = true;
      spawnNote(); // Start spawning notes when music begins
    }

    function stopNotes() {
      isPlaying = false; // Stop spawning notes when music is paused or stopped
    }

    audioPlayer.addEventListener('play', startNotes);
    audioPlayer.addEventListener('pause', stopNotes);
    audioPlayer.addEventListener('ended', stopNotes);

    function handleDiscDrop(name, imageUrl) {
      const oggUrl = buildOggUrl(name);
      discImage.src = imageUrl;
      discImage.alt = "";  // Clear the alt text
      audioPlayer.src = oggUrl;
      audioPlayer.play().catch(err => {
        alert("Couldn't play audio. May not exist or be blocked by browser.");
        console.error(err);
      });
    }

    function addToInventory(name, imageUrl) {
      for (const slot of inventorySlots) {
        if (!slot.hasChildNodes()) {
          const img = document.createElement('img');
          img.src = imageUrl;
          img.alt = name;
          img.draggable = true;
          slot.appendChild(img);

          // Set up the drag functionality for the newly added image
          img.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text', name);
            e.dataTransfer.setData('image', imageUrl);
          });
          break;
        }
      }
    }

    dragArea.addEventListener('dragover', e => {
      e.preventDefault();
      dragArea.style.backgroundColor = '#333';
    });

    dragArea.addEventListener('dragleave', () => {
      dragArea.style.backgroundColor = '#222';
    });

    dragArea.addEventListener('drop', e => {
      e.preventDefault();
      dragArea.style.backgroundColor = '#222';

      const item = e.dataTransfer.items?.[0];
      if (item?.kind === 'file') {
        const file = item.getAsFile();
        const name = normalizeDiscName(file.name);
        if (name) handleDiscDrop(name, URL.createObjectURL(file));
        else alert("Couldn't extract disc name from filename.");
      } else if (item?.kind === 'string') {
        item.getAsString(url => {
          try {
            const parsedUrl = new URL(url);
            const filename = parsedUrl.pathname.split('/').pop();
            const name = normalizeDiscName(filename);
            if (name) handleDiscDrop(name, url);
            else alert("Couldn't extract disc name from URL.");
          } catch {
            alert("Invalid URL dropped.");
          }
        });
      }
    });

    // Handle drop in inventory
    for (const slot of inventorySlots) {
      slot.addEventListener('dragover', e => {
        e.preventDefault();
        slot.style.backgroundColor = '#444';
      });

      slot.addEventListener('dragleave', () => {
        slot.style.backgroundColor = '#555';
      });

      slot.addEventListener('drop', (e) => {
        e.preventDefault();
        const name = e.dataTransfer.getData('text');
        const imageUrl = e.dataTransfer.getData('image');
        addToInventory(name, imageUrl);
      });
    }
    // Get disc from URL
    const urlParams = new URLSearchParams(window.location.search);
    const disc = urlParams.get('disc');

    if (disc) {
      // Format for display and image
      const formattedName = disc
        .split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join('_');
      console.log(formattedName)
      // Set title and image
      document.getElementById('disc-image').src = `https://minecraft.wiki/images/Invicon_Music_Disc_${formattedName}.png`;
    const audio = document.getElementById('audio-player');
    audio.src = `https://tggamesyt.github.io/jukebox/${disc}.ogg`;
    };
</script>
</body>
</html>
