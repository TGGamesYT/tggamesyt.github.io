<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Basic Speed Test</title>
<style>
  :root { --bg:#0f172a; --fg:#e2e8f0; --muted:#94a3b8; --card:#111827; --accent:#38bdf8; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji','Segoe UI Emoji'; background:linear-gradient(180deg,#0b1023,#0f172a); color:var(--fg); }
  .wrap { max-width: 820px; margin: 32px auto; padding: 0 16px; }
  .card { background: radial-gradient(1200px 600px at 10% -20%, #10243e 0%, #0b1220 60%, #0a0f1f 100%), var(--card);
          border: 1px solid rgba(255,255,255,0.06); border-radius: 20px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); }
  h1 { margin: 0 0 12px; font-weight: 800; letter-spacing: 0.3px; }
  p { color: var(--muted); margin: 6px 0 0; }
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 16px; }
  .info, .results { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);
                    border-radius: 16px; padding: 16px; min-height: 140px; }
  .row { display:flex; align-items:center; justify-content:space-between; gap:8px; padding:10px 0; border-bottom:1px dashed rgba(255,255,255,0.08); }
  .row:last-child { border-bottom: none; }
  .label { color: #cbd5e1; font-weight: 600; }
  .value { color: #ffffff; font-variant-numeric: tabular-nums; }
  .value.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  .actions { display:flex; gap:12px; margin-top: 16px; align-items: center; flex-wrap: wrap; }
  button { flex:1; appearance:none; border:none; border-radius: 999px; padding: 14px; font-weight: 700; cursor: pointer; color:#001018;
           background: linear-gradient(180deg,#67e8f9,#38bdf8); box-shadow: 0 8px 24px rgba(56,189,248,0.35); min-width: 120px; }
  button[disabled] { opacity: 0.6; cursor: not-allowed; }
  .pill { padding:6px 12px; border-radius:999px; border:1px solid rgba(255,255,255,0.12); color:#cbd5e1; white-space: nowrap; }
  progress { width: 100%; height: 10px; border-radius: 6px; overflow:hidden; }
  progress::-webkit-progress-bar { background: rgba(255,255,255,0.08); }
  progress::-webkit-progress-value { background: var(--accent); }
  .small { font-size: 12px; color: var(--muted); }
  .foot { margin-top: 12px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
  a { color:#7dd3fc; text-decoration: none; }

  /* ðŸ“± Responsive: stack layout on small screens */
  @media (max-width: 640px) {
    .grid { grid-template-columns: 1fr; }
    .actions { flex-direction: column; align-items: stretch; }
    button { width: 100%; }
    .pill { align-self: center; }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Basic Speed Test</h1>
      <p>Press start to run a 10s download and 10s upload test. Results are shown in Mbps.</p>

      <div class="grid">
        <div class="info">
          <div class="row"><div class="label">Device</div><div class="value" id="deviceName">â€”</div></div>
          <div class="row"><div class="label">Browser</div><div class="value" id="browserName">â€”</div></div>
          <div class="row"><div class="label">Service Provider</div><div class="value" id="isp">Detectingâ€¦</div></div>
          <div class="row"><div class="label">Network</div><div class="value" id="netInfo">â€”</div></div>
        </div>

        <div class="results">
          <div class="row"><div class="label">Download</div><div class="value mono" id="downVal">0.00 Mbps</div></div>
          <div class="row"><div class="label">Upload</div><div class="value mono" id="upVal">0.00 Mbps</div></div>
          <div class="row"><div class="label">Status</div><div class="value" id="status">Idle</div></div>
          <div class="row" style="padding-bottom:0">
            <progress id="progress" max="1" value="0"></progress>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="startBtn">Start Test</button>
        <span class="pill" id="timer">00:00</span>
      </div>

      <div class="foot small">
        <div>Tip: keep this tab focused for best accuracy.</div>
        <div>
          Sources: Download via <code>speed.cloudflare.com/__down</code>, Upload via <code>speed.cloudflare.com/__up</code>. ISP via <code>ipapi.co</code>.
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const downVal = $('downVal'), upVal = $('upVal'), statusEl = $('status'), prog = $('progress'), timerEl = $('timer'), btn = $('startBtn');

  const MBIT = 8 / (1000*1000); // bytes â†’ megabits
  function fmtMbps(bps){ return (bps * MBIT).toFixed(2) + ' Mbps'; }
  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
  function setStatus(s){ statusEl.textContent = s; }

  function startTimer(durationMs){
    const t0 = performance.now();
    return setInterval(() => {
      const elapsed = Math.min(performance.now() - t0, durationMs);
      const secs = Math.ceil((durationMs - elapsed)/1000);
      const mm = String(Math.floor(secs/60)).padStart(2,'0');
      const ss = String(Math.max(secs%60,0)).padStart(2,'0');
      timerEl.textContent = `${mm}:${ss}`;
      prog.value = elapsed / durationMs;
    }, 200);
  }

  // --- Download test
  async function runDownload(durationMs=10000){
    setStatus('Downloadingâ€¦');
    let bytes = 0;
    const tStart = performance.now();
    const deadline = tStart + durationMs;
    while (performance.now() < deadline) {
      try {
        const res = await fetch(`https://speed.cloudflare.com/__down?bytes=20000000&r=${Math.random()}`, {cache:'no-store'});
        const reader = res.body.getReader();
        while (true) {
          const {done, value} = await reader.read();
          if (done) break;
          bytes += value.byteLength;
          const seconds = (performance.now()-tStart)/1000;
          downVal.textContent = fmtMbps(bytes/seconds);
          if (performance.now() >= deadline) break;
        }
      } catch {}
    }
    const seconds = (performance.now()-tStart)/1000;
    return bytes/seconds;
  }

  // --- Upload test (live updates added âœ…)
  // --- Upload test (fixed getRandomValues issue)
async function runUpload(durationMs=10000){
  setStatus('Uploadingâ€¦');
  let bytes = 0;
  const tStart = performance.now();
  const deadline = tStart + durationMs;

  // Just fill with zeros (no need for randomness, saves CPU)
  const chunk = new Uint8Array(65536); // safe max
  const repeats = 16;                  // 16 * 64KB â‰ˆ 1MB
  const payload = new Uint8Array(chunk.length * repeats);
  for (let i=0;i<repeats;i++) payload.set(chunk,i*chunk.length);

  while (performance.now() < deadline) {
    try {
      await fetch('https://speed.cloudflare.com/__up', {
        method: 'POST',
        body: payload.buffer,
        headers: {'Content-Type':'application/octet-stream'},
        cache:'no-store'
      });
      bytes += payload.byteLength;
      const seconds = (performance.now()-tStart)/1000;
      upVal.textContent = fmtMbps(bytes/seconds); // live update
    } catch {}
  }

  const seconds = (performance.now()-tStart)/1000;
  return bytes/seconds;
}

  btn.addEventListener('click', async () => {
    if (btn.disabled) return;
    btn.disabled = true;
    downVal.textContent = '0.00 Mbps';
    upVal.textContent = '0.00 Mbps';
    prog.value = 0;

    // Download phase
    timerEl.textContent = '00:10';
    const timer1 = startTimer(10000);
    const downBps = await runDownload(10000);
    clearInterval(timer1);
    prog.value = 1;
    downVal.textContent = fmtMbps(downBps);

    await sleep(400);

    // Upload phase
    prog.value = 0;
    timerEl.textContent = '00:10';
    const timer2 = startTimer(10000);
    const upBps = await runUpload(10000);
    clearInterval(timer2);
    prog.value = 1;
    upVal.textContent = fmtMbps(upBps);

    setStatus('Done');
    btn.disabled = false;
  });
})();
</script>
</body>
</html>
