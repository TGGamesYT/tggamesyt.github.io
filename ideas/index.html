<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Shared Document</title>
<style>
  body{font-family:system-ui,Arial;max-width:900px;margin:28px auto;padding:0 12px}
  textarea{width:100%;height:360px;font-family:monospace;font-size:13px}
  .muted{color:#666;font-size:13px}
  .btn{padding:8px 12px;border-radius:6px;border:1px solid #888;background:#f3f3f3;cursor:pointer}
</style>
</head>
<body>
  <h1>Shared Document</h1>
  <div id="status" class="muted">Checking...</div>

  <div id="notAllowed" style="display:none;margin-top:12px">
    <p>You are <strong>not</strong> whitelisted. Your public IP is <span id="clientIp" style="font-weight:700"></span>.</p>
    <p class="muted">Add that IP to the worker WHITELIST (exact IP) to be able to edit.</p>
  </div>

  <div id="editorArea" style="display:none;margin-top:12px">
    <p class="muted">You are whitelisted â€” edit below and press Save.</p>
    <textarea id="docArea">{ }</textarea><br/>
    <button id="saveBtn" class="btn">Save</button>
    <span id="saveStatus" class="muted" style="margin-left:12px"></span>
  </div>

<script>
const WORKER_BASE = "https://ideas.tgdoescode.workers.dev"; // your worker

async function init() {
  const status = document.getElementById("status");
  try {
    const res = await fetch(WORKER_BASE + "/doc", { method: "GET", credentials: "omit" });
    // if fetch itself fails, it's network/CORS or wrong URL
    const payload = await res.json();
    if (!payload.allowed) {
      status.textContent = "Not whitelisted.";
      document.getElementById("clientIp").textContent = payload.ip || "(unknown)";
      document.getElementById("notAllowed").style.display = "block";
      return;
    }

    status.textContent = `Whitelisted (IP: ${payload.ip}). Document loaded.`;
    document.getElementById("editorArea").style.display = "block";
    document.getElementById("docArea").value = payload.content || "";
    document.getElementById("saveBtn").onclick = saveDoc;
  } catch (err) {
    status.textContent = "Error contacting worker: " + err.message;
    console.error(err);
  }
}

async function saveDoc() {
  const s = document.getElementById("saveStatus");
  s.textContent = "Saving...";
  try {
    const body = document.getElementById("docArea").value;
    const res = await fetch(WORKER_BASE + "/doc", {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body
    });
    if (res.ok) {
      s.textContent = "Saved.";
    } else {
      s.textContent = "Save failed: " + res.status;
    }
  } catch (err) {
    s.textContent = "Save error: " + err.message;
  }
}

init();
</script>
</body>
</html>
